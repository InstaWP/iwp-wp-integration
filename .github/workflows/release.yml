name: Release Plugin

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify version matches plugin header
        run: |
          PLUGIN_VERSION=$(grep -oP "(?<=Version:\s)[\d\.]+" iwp-wp-integration.php | head -1)
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Plugin version: $PLUGIN_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Plugin version ($PLUGIN_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi

      - name: Create build directory
        run: mkdir -p build/iwp-wp-integration

      - name: Copy plugin files
        run: |
          rsync -av --progress . build/iwp-wp-integration/ \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='.DS_Store' \
            --exclude='*.log' \
            --exclude='debug-*.php' \
            --exclude='test.php' \
            --exclude='DEBUG-SCRIPTS.md' \
            --exclude='phpunit.xml' \
            --exclude='tests' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='*.md.bak' \
            --exclude='build' \
            --exclude='CLAUDE.md' \
            --exclude='TESTING-PLAN.md' \
            --exclude='MIGRATION-GUIDE.md' \
            --exclude='admin-migrate.php' \
            --exclude='migrate-db.php'

      - name: Create plugin zip
        run: |
          cd build
          zip -r iwp-wp-integration-${{ steps.get_version.outputs.VERSION }}.zip iwp-wp-integration/
          cd ..

      - name: Generate changelog for release
        id: changelog
        run: |
          # Extract changelog for current version from CHANGELOG.md
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' > release_notes.md

          # If changelog is empty, use a default message
          if [ ! -s release_notes.md ]; then
            echo "Release v$VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release_notes.md
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: InstaWP Integration v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: build/iwp-wp-integration-${{ steps.get_version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: iwp-wp-integration-${{ steps.get_version.outputs.VERSION }}
          path: build/iwp-wp-integration-${{ steps.get_version.outputs.VERSION }}.zip
          retention-days: 90

      - name: Output release information
        run: |
          echo "âœ… Release created successfully!"
          echo "Version: ${{ steps.get_version.outputs.VERSION }}"
          echo "Download URL: ${{ steps.create_release.outputs.upload_url }}"
